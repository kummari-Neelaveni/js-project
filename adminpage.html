<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Auth System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
       /*body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5; 
            background-image: url('your-image-url.jpg');
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat; 
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }  */
       
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            max-width: 420px;
        }
        .tabs {
            display: flex;
            background-color: #f1f1f1;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .tab.active {
            background-color: #4285f4;
            color: white;
        }
        .form-container {
            padding: 25px;
        }
        h2 {
            margin-top: 0;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #4285f4;
        }
        .error {
            color: #e53935;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 14px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3367d6;
        }
        .login-options {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .login-option {
            display: none;
        }
        .login-option.active {
            display: block;
        }
        .switch-option {
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }
        .switch-btn {
            color: #4285f4;
            background: none;
            border: none;
            padding: 0;
            font-size: 14px;
            cursor: pointer;
            width: auto;
            text-decoration: underline;
            display: inline;
        }
        .login-method-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .login-method-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .login-method-tab.active {
            border-bottom: 2px solid #4285f4;
            color: #4285f4;
            font-weight: 600;
        }
        .notification {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .error-notif {
            background-color: #ffebee;
            color: #c62828;
        }
        .verification-container {
            display: none;
            margin-top: 15px;
        }
        .resend-btn {
            color: #4285f4;
            background: none;
            border: none;
            padding: 0;
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 10px;
            display: block;
            text-align: center;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 40px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            background-image: url('https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/eye.svg');
            background-size: cover;
            background-repeat: no-repeat;
        }
        .password-toggle.hidden {
            background-image: url('https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/eye-off.svg');
        }
        .forgot-password {
            text-align: right;
            margin-bottom: 15px;
        }
        .forgot-password a {
            color: #4285f4;
            text-decoration: none;
            font-size: 14px;
        }
        .forgot-password a:hover {
            text-decoration: underline;
        }
        /* Added styles for tabs in forgot password form */
        .reset-method-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .reset-method-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .reset-method-tab.active {
            border-bottom: 2px solid #4285f4;
            color: #4285f4;
            font-weight: 600;
        }
        .reset-option {
            display: none;
        }
        .reset-option.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" id="login-tab">Login</div>
            <div class="tab" id="signup-tab">Sign Up</div>
        </div>
        
        <div class="form-container">
            <div id="notification" class="notification"></div>
            
            <div id="login-form">
                <h2>Welcome Back</h2>
                
                <div class="login-method-tabs">
                    <div class="login-method-tab active" data-method="email">Email</div>
                    <div class="login-method-tab" data-method="phone">Phone</div>
                </div>
                
                <div class="login-option active" id="email-login">
                    <div class="input-group">
                        <label for="login-email">Email Address</label>
                        <input type="email" id="login-email" placeholder="your@email.com">
                        <div class="error" id="login-email-error"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="•••••••••">
                        <span class="password-toggle"></span>
                        <div class="error" id="login-password-error"></div>
                    </div>
                    
                    <div class="forgot-password">
                        <a href="#" id="forgot-password-link">Forgot Password?</a>
                    </div>
                </div>
                
                <div class="login-option" id="phone-login">
                    <div class="input-group">
                        <label for="login-phone">Phone Number</label>
                        <input type="tel" id="login-phone" placeholder="+1234567890">
                        <div class="error" id="login-phone-error"></div>
                    </div>
                    
                    <div id="recaptcha-container"></div>
                    
                    <div class="verification-container" id="verification-container">
                        <div class="input-group">
                            <label for="verification-code">Verification Code</label>
                            <input type="text" id="verification-code" placeholder="Enter verification code">
                            <div class="error" id="verification-code-error"></div>
                        </div>
                        <button id="verify-code-btn">Verify Code</button>
                        <button class="resend-btn" id="resend-code-btn">Resend Code</button>
                    </div>
                </div>
                
                <button id="login-btn" onclick="window.location.href='admin-dashboard.html'">Login</button>
                
                <div class="switch-option">
                    Don't have an account? <button class="switch-btn" id="switch-to-signup">Sign Up</button>
                </div>
            </div>
            
            <div id="signup-form" style="display:none;">
                <h2>Create Account</h2>
                
                <div class="input-group">
                    <label for="signup-email">Email Address</label>
                    <input type="email" id="signup-email" placeholder="your@email.com">
                    <div class="error" id="signup-email-error"></div>
                </div>
                
                <div class="input-group">
                    <label for="signup-phone">Phone Number</label>
                    <input type="tel" id="signup-phone" placeholder="+1234567890">
                    <div class="error" id="signup-phone-error"></div>
                </div>
                
                <div class="input-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="•••••••••">
                    <span class="password-toggle"></span>
                    <div class="error" id="signup-password-error"></div>
                </div>
                
                <div class="input-group">
                    <label for="signup-confirm-password">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" placeholder="•••••••••">
                    <span class="password-toggle"></span>
                    <div class="error" id="signup-confirm-password-error"></div>
                </div>
                
                <button id="signup-btn">Create Account</button>
                
                <div class="switch-option">
                    Already have an account? <button class="switch-btn" id="switch-to-login">Login</button>
                </div>
            </div>
            
            <div id="forgot-password-form" style="display:none;">
                <h2>Reset Password</h2>
                
                <div class="reset-method-tabs">
                    <div class="reset-method-tab active" data-method="email">Email</div>
                    <div class="reset-method-tab" data-method="phone">Phone</div>
                </div>
                
                <div class="reset-option active" id="email-reset">
                    <div class="input-group">
                        <label for="reset-email">Email Address</label>
                        <input type="email" id="reset-email" placeholder="your@email.com">
                        <div class="error" id="reset-email-error"></div>
                    </div>
                </div>
                
                <div class="reset-option" id="phone-reset">
                    <div class="input-group">
                        <label for="reset-phone">Phone Number</label>
                        <input type="tel" id="reset-phone" placeholder="+1234567890">
                        <div class="error" id="reset-phone-error"></div>
                    </div>
                    
                    <div id="reset-recaptcha-container"></div>
                    
                    <div class="verification-container" id="reset-verification-container">
                        <div class="input-group">
                            <label for="reset-verification-code">Verification Code</label>
                            <input type="text" id="reset-verification-code" placeholder="Enter verification code">
                            <div class="error" id="reset-verification-code-error"></div>
                        </div>
                        
                        <div class="input-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" placeholder="•••••••••">
                            <span class="password-toggle"></span>
                            <div class="error" id="new-password-error"></div>
                        </div>
                        
                        <div class="input-group">
                            <label for="confirm-new-password">Confirm New Password</label>
                            <input type="password" id="confirm-new-password" placeholder="•••••••••">
                            <span class="password-toggle"></span>
                            <div class="error" id="confirm-new-password-error"></div>
                        </div>
                        
                        <button id="update-password-btn">Update Password</button>
                        <button class="resend-btn" id="reset-resend-code-btn">Resend Code</button>
                    </div>
                </div>
                
                <button id="reset-password-btn">Send Reset Link</button>
                
                <div class="switch-option">
                    <button class="switch-btn" id="back-to-login">Back to Login</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDUvsnGvb2O9b7EkPdxdnbHZxqRbLJpt6Q",
            authDomain: "redbus1-b1c1d.firebaseapp.com",
            databaseURL: "https://redbus1-b1c1d-default-rtdb.firebaseio.com",
            projectId: "redbus1-b1c1d",
            storageBucket: "redbus1-b1c1d.firebasestorage.app",
            messagingSenderId: "774950462077",
            appId: "1:774950462077:web:a3ea58e75425a3a9870714"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // DOM Elements
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const switchToSignup = document.getElementById('switch-to-signup');
        const switchToLogin = document.getElementById('switch-to-login');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const backToLogin = document.getElementById('back-to-login');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const notification = document.getElementById('notification');
        const verificationContainer = document.getElementById('verification-container');
        const verifyCodeBtn = document.getElementById('verify-code-btn');
        const resendCodeBtn = document.getElementById('resend-code-btn');
        
        // Reset Password Elements
        const resetMethodTabs = document.querySelectorAll('.reset-method-tab');
        const resetOptions = document.querySelectorAll('.reset-option');
        const resetVerificationContainer = document.getElementById('reset-verification-container');
        const updatePasswordBtn = document.getElementById('update-password-btn');
        const resetResendCodeBtn = document.getElementById('reset-resend-code-btn');
        
        // Login Method Tabs
        const loginMethodTabs = document.querySelectorAll('.login-method-tab');
        const loginOptions = document.querySelectorAll('.login-option');
        
        // Phone authentication variables
        let verificationId = '';
        let resetVerificationId = '';
        let recaptchaVerifier;
        let resetRecaptchaVerifier;
        
        // Form Validation Patterns
        const patterns = {
            email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
            phone: /^\+?[0-9]{10,15}$/,
            password: /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$/
        };
        
        // Tab Switching Functions
        function showForm(form) {
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            forgotPasswordForm.style.display = 'none';
            
            form.style.display = 'block';
            clearErrors();
        }
        
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            showForm(loginForm);
        });
        
        signupTab.addEventListener('click', () => {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            showForm(signupForm);
        });
        
        switchToSignup.addEventListener('click', () => {
            signupTab.click();
        });
        
        switchToLogin.addEventListener('click', () => {
            loginTab.click();
        });
        
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            showForm(forgotPasswordForm);
            
            // Initialize recaptcha for phone reset
            initializeResetRecaptcha();
        });
        
        backToLogin.addEventListener('click', () => {
            showForm(loginForm);
        });
        
        // Login Method Tab Switching
        loginMethodTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                loginMethodTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const method = tab.getAttribute('data-method');
                loginOptions.forEach(option => option.classList.remove('active'));
                document.getElementById(`${method}-login`).classList.add('active');
                
                // Reset phone verification if switching tabs
                if (method === 'phone') {
                    initializeRecaptcha();
                    verificationContainer.style.display = 'none';
                    loginBtn.textContent = 'Send Code';
                    loginBtn.style.display = 'block';
                } else {
                    loginBtn.textContent = 'Login';
                }
                
                clearErrors();
            });
        });
        
        // Reset Method Tab Switching
        resetMethodTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                resetMethodTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const method = tab.getAttribute('data-method');
                resetOptions.forEach(option => option.classList.remove('active'));
                document.getElementById(`${method}-reset`).classList.add('active');
                
                // Reset verification container
                resetVerificationContainer.style.display = 'none';
                
                // Change button text based on method
                if (method === 'email') {
                    resetPasswordBtn.textContent = 'Send Reset Link';
                    resetPasswordBtn.style.display = 'block';
                } else {
                    resetPasswordBtn.textContent = 'Send Code';
                    resetPasswordBtn.style.display = 'block';
                    initializeResetRecaptcha();
                }
                
                clearErrors();
            });
        });
        
        // Initialize reCAPTCHA verifier for login
        function initializeRecaptcha() {
            if (recaptchaVerifier) {
                recaptchaVerifier.clear();
            }
            
            recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'normal',
                'callback': (response) => {
                    loginBtn.disabled = false;
                },
                'expired-callback': () => {
                    loginBtn.disabled = true;
                }
            });
            
            recaptchaVerifier.render();
        }
        
        // Initialize reCAPTCHA verifier for reset password
        function initializeResetRecaptcha() {
            if (resetRecaptchaVerifier) {
                resetRecaptchaVerifier.clear();
            }
            
            resetRecaptchaVerifier = new firebase.auth.RecaptchaVerifier('reset-recaptcha-container', {
                'size': 'normal',
                'callback': (response) => {
                    resetPasswordBtn.disabled = false;
                },
                'expired-callback': () => {
                    resetPasswordBtn.disabled = true;
                }
            });
            
            resetRecaptchaVerifier.render();
        }
        
        // Show Error Function
        function showError(inputId, message) {
            const errorElement = document.getElementById(`${inputId}-error`);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById(inputId).classList.add('invalid');
            return false;
        }
        
        // Clear Error Function
        function clearError(inputId) {
            const errorElement = document.getElementById(`${inputId}-error`);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
                const inputElement = document.getElementById(inputId);
                if (inputElement) {
                    inputElement.classList.remove('invalid');
                }
            }
        }
        
        // Clear All Errors
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error');
            errorElements.forEach(element => {
                element.textContent = '';
                element.style.display = 'none';
            });
            
            hideNotification();
        }
        
        // Show Notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }
        
        // Hide Notification
        function hideNotification() {
            notification.style.display = 'none';
        }
        
        // Validate Signup Form
        function validateSignupForm() {
            clearErrors();
            let isValid = true;
            
            // Email validation
            const email = document.getElementById('signup-email').value.trim();
            if (!email) {
                isValid = showError('signup-email', 'Email is required');
            } else if (!patterns.email.test(email)) {
                isValid = showError('signup-email', 'Please enter a valid email address');
            }
            
            // Phone validation
            const phone = document.getElementById('signup-phone').value.trim();
            if (!phone) {
                isValid = showError('signup-phone', 'Phone number is required');
            } else if (!patterns.phone.test(phone)) {
                isValid = showError('signup-phone', 'Please enter a valid phone number');
            }
            
            // Password validation
            const password = document.getElementById('signup-password').value;
            if (!password) {
                isValid = showError('signup-password', 'Password is required');
            } else if (!patterns.password.test(password)) {
                isValid = showError('signup-password', 'Password must be at least 8 characters with at least one letter and one number');
            }
            
            // Confirm password validation
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            if (!confirmPassword) {
                isValid = showError('signup-confirm-password', 'Please confirm your password');
            } else if (password !== confirmPassword) {
                isValid = showError('signup-confirm-password', 'Passwords do not match');
            }
            
            return isValid;
        }
        
        // Validate Login Form
        function validateLoginForm() {
            clearErrors();
            let isValid = true;
            
            const activeTab = document.querySelector('.login-method-tab.active').getAttribute('data-method');
            
            // Validate based on active login method
            if (activeTab === 'email') {
                const email = document.getElementById('login-email').value.trim();
                if (!email) {
                    isValid = showError('login-email', 'Email is required');
                } else if (!patterns.email.test(email)) {
                    isValid = showError('login-email', 'Please enter a valid email address');
                }
                
                // Password validation for email login
                const password = document.getElementById('login-password').value;
                if (!password) {
                    isValid = showError('login-password', 'Password is required');
                }
            } else if (activeTab === 'phone') {
                const phone = document.getElementById('login-phone').value.trim();
                if (!phone) {
                    isValid = showError('login-phone', 'Phone number is required');
                } else if (!patterns.phone.test(phone)) {
                    isValid = showError('login-phone', 'Please enter a valid phone number');
                }
                
                // If verification container is visible, validate code
                if (verificationContainer.style.display === 'block') {
                    const code = document.getElementById('verification-code').value.trim();
                    if (!code) {
                        isValid = showError('verification-code', 'Verification code is required');
                    } else if (code.length < 6) {
                        isValid = showError('verification-code', 'Please enter a valid verification code');
                    }
                }
            }
            
            return isValid;
        }
        
        // Validate Reset Password Form
        function validateResetPasswordForm() {
            clearErrors();
            let isValid = true;
            
            const activeTab = document.querySelector('.reset-method-tab.active').getAttribute('data-method');
            
            // Validate based on active reset method
            if (activeTab === 'email') {
                const email = document.getElementById('reset-email').value.trim();
                if (!email) {
                    isValid = showError('reset-email', 'Email is required');
                } else if (!patterns.email.test(email)) {
                    isValid = showError('reset-email', 'Please enter a valid email address');
                }
            } else if (activeTab === 'phone') {
                const phone = document.getElementById('reset-phone').value.trim();
                if (!phone) {
                    isValid = showError('reset-phone', 'Phone number is required');
                } else if (!patterns.phone.test(phone)) {
                    isValid = showError('reset-phone', 'Please enter a valid phone number');
                }
                
                // If verification container is visible, validate fields
                if (resetVerificationContainer.style.display === 'block') {
                    const code = document.getElementById('reset-verification-code').value.trim();
                    if (!code) {
                        isValid = showError('reset-verification-code', 'Verification code is required');
                    } else if (code.length < 6) {
                        isValid = showError('reset-verification-code', 'Please enter a valid verification code');
                    }
                    
                    const newPassword = document.getElementById('new-password').value;
                    if (!newPassword) {
                        isValid = showError('new-password', 'New password is required');
                    } else if (!patterns.password.test(newPassword)) {
                        isValid = showError('new-password', 'Password must be at least 8 characters with at least one letter and one number');
                    }
                    
                    const confirmNewPassword = document.getElementById('confirm-new-password').value;
                    if (!confirmNewPassword) {
                        isValid = showError('confirm-new-password', 'Please confirm your new password');
                    } else if (newPassword !== confirmNewPassword) {
                        isValid = showError('confirm-new-password', 'Passwords do not match');
                    }
                }
            }
            
            return isValid;
        }
        
        // Function to save user data to Firestore
        function saveUserData(user, additionalData = {}) {
            return db.collection('users').doc(user.uid).set({
                uid: user.uid,
                email: user.email,
                ...additionalData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
        
        signupBtn.addEventListener('click', () => {
            if (validateSignupForm()) {
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                
                // Create user with email and password
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        
                        // Send email verification
                        return user.sendEmailVerification()
                            .then(() => {
                                // Save user data to Firestore
                                return saveUserData(user, {
                                    displayName: '', // Initialize display name
                                    photoURL: '',    // Initialize photo URL
                                    role: 'user'       // Set default role
                                });
                            });
                    })
                    .then(() => {
                        showNotification('Account created successfully! Please check your email to verify your account.', 'success');
                        setTimeout(() => {
                            loginTab.click(); // Switch to login tab
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error("Error creating user:", error);
                        let errorMessage = "Failed to create account. Please try again.";
                        
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage = "This email is already in use by another account.";
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = "Password is too weak. Please choose a stronger password.";
                        }
                        
                        showNotification(errorMessage, 'error-notif');
                    });
            }
        });
        
        // Login Functionality
        loginBtn.addEventListener('click', () => {
            const activeTab = document.querySelector('.login-method-tab.active').getAttribute('data-method');
            
            if (activeTab === 'email') {
                // Handle email login
                if (validateLoginForm()) {
                    const email = document.getElementById('login-email').value.trim();
                    const password = document.getElementById('login-password').value;
                    
                    auth.signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            
                            if (user.emailVerified) {
                                // Get user data from Firestore
                                return db.collection('users').doc(user.uid).get()
                                    .then((doc) => {
                                        if (doc.exists) {
                                            // User data exists, proceed to dashboard
                                            showNotification('Login successful!', 'success');
                                            setTimeout(() => {
                                                // window.location.href = 'dashboard.html';
                                                console.log('Redirect to dashboard');
                                            }, 1500);
                                        } else {
                                            // User data does not exist, save it (shouldn't happen in normal case)
                                            saveUserData(user, {
                                                displayName: user.displayName || '',
                                                photoURL: user.photoURL || '',
                                                role: 'user'
                                            }).then(()=>{
                                                 showNotification('Login successful!', 'success');
                                                 setTimeout(() => {
                                                    // window.location.href = 'dashboard.html';
                                                    console.log('Redirect to dashboard');
                                                }, 1500);
                                            })
                                        }
                                    });
                            } else {
                                // Send email verification again
                                user.sendEmailVerification();
                                auth.signOut();
                                showNotification('Please verify your email before logging in. A new verification email has been sent.', 'error-notif');
                            }
                        })
                        .catch((error) => {
                            console.error("Login error:", error);
                            let errorMessage = "Failed to login. Please check your credentials.";
                            
                            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                                errorMessage = "Invalid email or password. Please try again.";
                            } else if (error.code === 'auth/too-many-requests') {
                                errorMessage = "Too many failed login attempts. Please try again later.";
                            }
                            
                            showNotification(errorMessage, 'error-notif');
                        });
                }
            } else if (activeTab === 'phone') {
                // Handle phone login
                if (verificationContainer.style.display === 'none') {
                    // Step 1: Send verification code
                    if (validateLoginForm()) {
                        const phoneNumber = document.getElementById('login-phone').value.trim();
                        
                        auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifier)
                            .then((confirmationResult) => {
                                // SMS sent. Prompt user to type the code.
                                verificationId = confirmationResult.verificationId;
                                verificationContainer.style.display = 'block';
                                loginBtn.style.display = 'none';
                                showNotification('Verification code sent to your phone number.', 'success');
                            })
                            .catch((error) => {
                                console.error("Phone auth error:", error);
                                showNotification('Error sending verification code. Please try again.', 'error-notif');
                                
                                //Reset reCAPTCHA
                                initializeRecaptcha();
                            });
                    }
                }
            }
        });
        
        // Verify Phone Code
        verifyCodeBtn.addEventListener('click', () => {
            const code = document.getElementById('verification-code').value.trim();
            
            if (!code) {
                showError('verification-code', 'Please enter the verification code');
                return;
            }
            
            // Create credential with verification ID and code
            const credential = firebase.auth.PhoneAuthProvider.credential(verificationId, code);
            
            // Sign in with credential
            auth.signInWithCredential(credential)
                .then((userCredential) => {
                    const user = userCredential.user;
                    // Get user data.  If it doesn't exist, create it.
                    return db.collection('users').doc(user.uid).get()
                        .then(doc => {
                            if (doc.exists) {
                                return Promise.resolve(user); // Return user for chaining
                            } else {
                                // save user data.
                                return saveUserData(user, {
                                    displayName: '', // Initialize
                                    photoURL: '',
                                    role: 'user'
                                });
                            }
                        });
                })
                .then((user) => {
                    showNotification('Phone verification successful!', 'success');
                    setTimeout(() => {
                        // window.location.href = 'dashboard.html';
                        console.log('Redirect to dashboard');
                    }, 1500);
                })
                .catch((error) => {
                    console.error("Verification error:", error);
                    showError('verification-code', 'Invalid verification code. Please try again.');
                });
        });
        
        // Resend verification code
        resendCodeBtn.addEventListener('click', () => {
            const phoneNumber = document.getElementById('login-phone').value.trim();
            
            // Reset reCAPTCHA
            initializeRecaptcha();
            
            auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifier)
                .then((confirmationResult) => {
                    // SMS sent. Prompt user to type the code.
                    verificationId = confirmationResult.verificationId;
                    showNotification('Verification code resent to your phone number.', 'success');
                })
                .catch((error) => {
                    console.error("Resend code error:", error);
                    showNotification('Error resending verification code. Please try again.', 'error-notif');
                });
        });
        
        // Input validation event listeners
        document.getElementById('signup-email').addEventListener('input', () => clearError('signup-email'));
        document.getElementById('signup-password').addEventListener('input', () => {
            clearError('signup-password');
        });
        document.getElementById('signup-confirm-password').addEventListener('input', () => {
            clearError('signup-confirm-password')
        });
        
        document.getElementById('login-email').addEventListener('input', () => clearError('login-email'));
        document.getElementById('login-password').addEventListener('input', () => clearError('login-password'));
        document.getElementById('login-phone').addEventListener('input', () => clearError('login-phone'));
        document.getElementById('verification-code').addEventListener('input', () => clearError('verification-code'));
        
        // Initialize phone authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already signed in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('User is already signed in:', user.uid);
                    // Redirect to dashboard or home page
                    // window.location.href = 'dashboard.html';
                }
            });
            
            // Add event listeners to password toggle icons
            const passwordToggles = document.querySelectorAll('.password-toggle');
            passwordToggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const input = toggle.previousElementSibling; // Get the input element
                    if (input.type === 'password') {
                        input.type = 'text';
                        toggle.classList.add('hidden'); // Change eye icon
                    } else {
                        input.type = 'password';
                        toggle.classList.remove('hidden');
                    }
                });
            });
        });
    </script>
</body>
</html>

